on: # push
  push:
    branches:
      - main

name: deployment-workflow
jobs:

  deployment:
    name: deployment
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: [3.8]
    steps:

      - name: Check out source repository
        id: checkoutsourcerepo
        uses: actions/checkout@v2

      - name: Configure SSH to worker
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.PRIVATE_SSH_KEY }}" > ~/.ssh/staging.key
          chmod 600 ~/.ssh/staging.key
          cat >>~/.ssh/config <<END
          Host server
            HostName ${{ secrets.HOST-WORKER }}
            User root
            IdentityFile ~/.ssh/staging.key
            StrictHostKeyChecking no
          END

          
      # generates the core version based on the core-version file
      - name: Generate core-versions
        id: generatecoreversions
        uses: HardNorth/github-version-generate@v1.1.0
        with:
          version-source: file
          version-file: versions/core-version.txt
          next-version-increment-patch: ${{ contains(env.VERSION_FRAGMENT, 'patch') }}
          next-version-increment-minor: ${{ contains(env.VERSION_FRAGMENT, 'minor') }}
          next-version-increment-major: ${{ contains(env.VERSION_FRAGMENT, 'major') }}


      - name: Deploy to Server Rsync
        run: chmod -R 777 serverfiles/* && ./serverfiles/rsync-deploy.sh live worker